Генераторы последовательностей. SEQUENCE – Telegraph

Генераторы последовательностей. SEQUENCE
========================================

[Дорогу осилит идущий](https://t.me/ViamSupervadetVadens)September 17, 2023

Генераторы последовательностей. SEQUENCE

===========================================

[Дорогу осилит идущий](https://t.me/ViamSupervadetVadens)

В рамках этого урока познакомимся с простым, но важным для целостной картины, механизмом **последовательностей** (они же - **sequence**). Касаясь PostgreSQL, именно на этом механизме основаны инкрементирующиеся типы данных вроде _bigserial_ \- именно последовательности обеспечивают увеличение значения.

Прежде чем приступим к разбору синтаксиса, подсвечу несколько моментов:

1.  Изменения последовательностей не откатываются при неудачной транзакции. Из-за этого могут быть разрывы в порядке числовых _id_, если он представлен serial-типов или в иных случаях, когда столбец наполняется значением последовательности. Иногда это может иметь значение - например, если последовательность наполняет номера или иные атрибуты, которые должны идти строго по порядку. Например, номер документа/договора/протокола и пр. в зависимости от домена разрабатываемой системы. В таких случаях может потребоваться механизм программной установки значения после сброса или же вообще отказ от последовательности и замены его на иной механизм с похожей функциональностью;
2.  Стоит уточнять механизм взаимодействия последовательностей и оператора _TRUNCATE_ (или же, используется ли в механизме получения _id_ именно последовательность, а не иной механизм) - например, PostgreSQL не сбрасывает значение при вызове TRUNCATE-запроса для таблицы, но другие СУБД могут обнулять счетчик автоматически - скажем, это актуально для MySQL;
3.  Sequence является одним из возможных вариантов получения уникального в рамках своей зоны ответственности значения - это может быть актуально для распределенных систем, если мы не можем обеспечить уникальность числового значения средствами приложения, а UUID или иные генераторы уникальных значений не могут быть использованы в силу иных причин. В таком случае точкой синхронизации для параллельно работающих частей системы может выступить СУБД, а инструментом получения уникального значения - последовательность.



### Синтаксис

Sequence определен в стандарте SQL и в рамках DDL имеет достаточно стандартный синтаксис. Впрочем, как и с остальными сущностями, конкретная СУБД может иметь свои особенности. Поэтому предложенный синтаксис актуален, в первую очередь, для PostgreSQL. При работе с иными СУБД рекомендую дополнительно проверить возможные отличия.

Создание последовательности:

create sequence sequence\_name;

В базовом варианте достаточно указать название последовательности. Такой запрос создаст sequence с шагом изменения равным 1, начальным значением также будет 1, конечным - 2^63-1.

Эти параметры являются настраиваемыми. Например, создадим последовательность от 0 до 10000 с шагом 10:

create sequence limited\_sequence increment by 10
minvalue 0 maxvalue 10000;

Кроме того, мы можем зациклить последовательность, чтобы после достижения максимального значения последовательность начинала выдачу значений сначала. Если этого не сделать, после достижения максимального значения при каждой попытке получить следующее - будет ошибка. В зависимости от применения последовательности, будет отличаться и корректность применения зацикленности:

create sequence limited\_sequence\_cycle increment by 10
minvalue 0 maxvalue 10000 cycle;

Также можно сделать убывающую последовательность - для этого нужно указать отрицательный шаг изменения. При этом минимальным значением по умолчанию станет -1, а максимальным - 2^63-1. Но все также можно будет задать эти значения явно. 

  

Удаление последовательности тоже выглядит стандартно:

drop sequence sequence\_name;

И, наконец, используя _ALTER_ можно изменить шаг, минимальное и максимальное значения последовательности и несколько иных, не критичных на данном этапе, параметров. 

Кроме того, именно через _ALTER_ можно перезапустить последовательность (сбросить текущее значение и начать снова с минимального): 

alter sequence limited\_sequence restart;

Или с заданного явно:

alter sequence limited\_sequence restart with 25;

И бонусный пример - установка минимального значения выше текущего:

alter sequence limited\_sequence minvalue 100 start 100;

В данном случае, без _start_ была бы ошибка: начало (было 0 (нуль)) не может быть ниже минимального значения для возрастающей последовательности.

Теперь немного о том, как запросить значение из последовательности и иных функциях для работы с sequence.

Текущее (точнее, последнее возвращенное) значение последовательности на примере _limited\_sequence_:

select currval('limited\_sequence');

Обратите внимание на оговорку выше. Если вы вызовете _RESTART_ с начального значения, функция _currval()_ все равно вернет последнее полученное значение, а не начальное для данной последовательности.

Очевидно, функцию (как и другие), можно применять в любом запросе, а не только в _SELECT_.

Получить новое (следующее) значение:

select nextval('limited\_sequence');

И, наконец, установить текущее значение явно:

select setval('limited\_sequence', 140);

В отличии от рестарта последовательности, использование _setval()_ сохранит заявленное значение и для _currval()_.

Кроме того, для _setval()_ существует перегрузка: считать заданное значение следующим (для вызова _nextval()_):

select setval('limited\_sequence', 140, false);

или последним использованным (идентично вызову без булеан-параметра):

select setval('limited\_sequence', 140, true);

Чуть подробнее: [https://postgrespro.ru/docs/postgresql/9.6/functions-sequence](https://postgrespro.ru/docs/postgresql/9.6/functions-sequence)



На сегодня все!

Не вижу смысла в практике для данной темы - она достаточно простая и ее синтаксис не выходит за пределы общих правил, знакомых нам по DDL-разделу.

![](/file/8e3b871422a986531c7e3.png)

Если что-то непонятно или не получается – welcome в комменты к посту или в лс:)

Канал: [https://t.me/ViamSupervadetVadens](https://t.me/ViamSupervadetVadens)

Мой тг: [https://t.me/ironicMotherfucker](https://t.me/ironicMotherfucker)

_Дорогу осилит идущий!_

EditPublish

Report content on this page

Report Page
-----------

Violence Child Abuse  Copyright  Illegal Drugs  Personal Details  Other

Please submit your DMCA takedown request to [\[email protected\]](/cdn-cgi/l/email-protection#bdd9d0dedcfdc9d8d1d8dacfdcd093d2cfda82cec8dfd7d8dec980efd8cdd2cfc9988f8dc9d2988f8de9d8d1d8dacfdccdd5988f8dcddcdad8988f8d988f8f98f98d98848e98f98d98ff8898f98d98fff998f98d98ff8898f98c98858d98f98d98ff8d98f98c98858f98f98d98fff898f98c98858d98f98c9885ff988f8d98f98d98fffb98f98d98fff898f98c98858c98f98d98ffff98f98d98ff8898f98d98ff8998f98d98fff898f98d98ff8f98f98d98ff8d98f98c98858f98f98d98ff8898f98d98ffff98f98c9885fe98f98d98fff998f98d98fff898f98c98858c98f98c98858f98f98d98ff8898f98d98ff8493988f8deef8ece8f8f3fef8988f8f9bdfd2d9c480efd8cdd2cfc9d8d9988f8dcddcdad8988efc988f8dd5c9c9cdce988efc988ffb988ffbc9d8d1d8dacfdc93cdd5988ffbfad8d3d8cfdcc9d2cfc490cdd2ced1d8d9d2cbdcc9d8d1d3d2cec9d8d790eef8ece8f8f3fef8908d84908c8a988dfc988dfc988dfc)

Cancel Report

var T={"apiUrl":"https:\\/\\/edit.telegra.ph","datetime":1694958758,"pageId":"e325df9b881e3b147a5e6","editable":true};(function(){var b=document.querySelector('time');if(b&&T.datetime){var a=new Date(1E3\*T.datetime),d='January February March April May June July August September October November December'.split(' ')\[a.getMonth()\],c=a.getDate();b.innerText=d+' '+(10>c?'0':'')+c+', '+a.getFullYear()}})();